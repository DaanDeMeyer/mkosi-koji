#!/bin/sh
set -e

mkosi-chroot \
    sh -c 'cd $CHROOT_SRCDIR/mkosi && exec $0 "$@"' \
    rpmbuild \
    -bb \
    --build-in-place \
    $([[ "$WITH_TESTS" == "0" ]] && echo --nocheck) \
    --define "_topdir $CHROOT_SRCDIR/mkosi" \
    --define "_sourcedir $CHROOT_SRCDIR/mkosi/rpm" \
    --define "_rpmdir $CHROOT_OUTPUTDIR" \
    --define "_build_name_fmt %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm" \
    $CHROOT_SRCDIR/mkosi/rpm/mkosi.spec
